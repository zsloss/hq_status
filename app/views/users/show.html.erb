
<h1><%= @user.name %>'s Tasks</h1>

<table class="table table-hover">
  <thead>
    <tr>
      <th><%= sort_link "Flow", "flow" %></th>
      <th><%= sort_link "Document", "product" %></th>
      <th><%= sort_link "Start Date", "start_date" %></th>
      <th><%= sort_link "Status", "status" %></th>
      <th><%= sort_link "Latest Draft", "draft_submitted" %></th>
      <th></th>
      <th>Peer Review</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @remaining_tasks.each do |task| %>
    <tr>
      <td><%= task.flow %></td>
      <td><%= task.name %></td>
      <td><%= task.start_date %></td>

      <td>
        <%= form_for task do |f| %>
        <%= f.select :status, options_for_select(%w(Queued In\ Progress Pending), task.status), {}, { onchange: "this.form.submit()", class: "form-control" } %>
        <% end %>
      </td>

      <td>
        <% if task.draft and task.draft_submitted %>
        <%= "Draft #{task.draft} (#{days_ago task.draft_submitted})" %>
        <% end %>
      </td>
      
      <td>       
        <%= form_for task do |f| %> 
        <%= f.hidden_field :draft, value: task.draft ? task.draft + 1 : 1 %>
        <%= f.hidden_field :draft_submitted, value: Date.today %>
        <%= f.hidden_field :status, value: "Pending" %>
        <%= f.submit "Draft Sent", class: "btn btn-default" %>      
        <% end %>
      </td>     

      <td>
      <% if task.reviewer_id.nil? %>
        <%= form_for task do |f| %>
        <%= f.select :reviewer_id, options_for_select({ "None" => nil }.merge(User.get_options_for_select.except(@user.name)), task.reviewer_id), {}, { onchange: "this.form.submit()", class: "form-control" } %>
        <% end %>
      <% elsif task.review_status == "Reviewed" %>
        <span class="glyphicon glyphicon-ok"></span>
        Peer reviewed by <strong><%= task.reviewer %></strong>
      <% elsif task.review_status == "Sent" %>
        Sent to <strong><%= task.reviewer %></strong> for PR <%= task.review_sent_date.nil? ? "" : "(#{days_ago task.review_sent_date})" %>
      <% else %>
        <%= form_for task do |f| %>
        <%= f.hidden_field :review_status, value: "Sent" %>
        <%= f.hidden_field :review_sent_date, value: Date.today %>
        <%= f.submit "Send to #{task.reviewer} for PR", class: "btn btn-default" %>      
        <% end %> 
      <% end %>
      </td> 
      
      <td>
        <%= form_for task do |f| %>
        <%= f.hidden_field :done, value: true %>
        <%= f.hidden_field :completion_date, value: Date.today %>
        <%= f.submit "Done", { class: "btn btn-default", data: { confirm: 'Are you sure?'} } %>
        <% end %> 
      </td>

      <td><%= link_to 'Edit', edit_task_path(task) %></td>
      <td><%= link_to 'Delete', task, method: :delete, data: { confirm: 'Are you sure?' } %></td>
    </tr>
    <% end %>
  </tbody>
</table>

<div class="row">
  <div class="col-sm-3">

    <%= render 'shared/new_form' %>

  </div>
</div>

<br>

<h3>Peer Reviews</h3>

<table class="table table-hover">
  <thead>
    <tr>
      <th>Flow</th>
      <th>Document</th>
      <th>Writer</th>
      <th>Status</th>
      <th>Sent for Review</th>
      <th colspan="1"></th>
    </tr>
  </thead>

  <tbody>
    <% @peer_reviews.each do |task| %>
    <tr>
      <td><%= task.flow %></td>
      <td><%= task.name %></td>
      <td><%= task.writer %></td>
      <td><%= task.status %></td>
      <td>
        <span class="<%= task.review_status == 'Not Sent' ? 'glyphicon glyphicon-remove' : 'glyphicon glyphicon-ok' %>"></span>
        <% if task.review_sent_date %>
        <%= " (#{days_ago task.review_sent_date})" %>
        <% end %>
      </td>     
      <td>
        <%= form_for task do |f| %>
        <%= f.hidden_field :review_status, value: "Reviewed" %>
        <%= f.hidden_field :review_date, value: Date.today %>
        <%= f.submit "Peer Review Done", { class: "btn btn-default", data: { confirm: 'Are you sure?'} } %>
        <% end %>
      </td>
    </tr>
    <% end %>
  </tbody>
</table>

<h3>Completed Tasks</h3>

<table class="table table-hover">
  <thead>
    <tr>
      <th>Flow</th>
      <th>Document</th>
      <th>Completion Date</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @finished_tasks.each do |task| %>
    <tr>
      <td><%= task.flow %></td>
      <td><%= task.name %></td>
      <td>
        <%= task.completion_date ? task.completion_date : '' %>
      </td>      
      <td>
        <%= form_for task do |f| %>
        <%= f.hidden_field :done, value: false %>
        <%= f.hidden_field :completion_date, value: nil %>
        <%= f.submit "Resurrect", { class: "btn btn-default", data: { confirm: 'Are you sure?'} } %>
        <% end %>
      </td>
      <td><%= link_to 'Edit', edit_task_path(task) %></td>
      <td><%= link_to 'Delete', task, method: :delete, data: { confirm: 'Are you sure?' } %></td>
    </tr>
    <% end %>
  </tbody>
</table>